#+title: Ja0nz Emacs Configuration
#+STARTUP: fold
#+PROPERTY: header-args:emacs-lisp :tangle ~/.doom.d/config.el :mkdirp yes

* File Headers
#+begin_src emacs-lisp
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-
#+end_src

#+begin_src emacs-lisp :tangle ~/.doom.d/packages.el
;; -*- no-byte-compile: t; -*-
;;; $DOOMDIR/packages.el
#+end_src

* Base settings
Here are some additional functions/macros that could help you configure Doom:
- `load!' for loading external *.el files relative to this one
- `use-package!' for configuring packages
- `after!' for running code after a package has loaded
- `add-load-path!' for adding directories to the `load-path', relative to this file. Emacs searches the `load-path' when you load packages with `require' or `use-package'.
- `map!' for binding new keys

** Prelude
#+begin_src emacs-lisp
;; Some functionality uses this to identify you, e.g. GPG configuration, email clients, file templates and snippets.
(setq user-full-name "Ja0nz"
      user-mail-address "mail@ja.nz")

;; Use nr instead of jk - Neo2 Keyboard layout
(use-package! evil-escape
  :init (setq evil-escape-key-sequence "nr"))

;; Use primary selection instead of clipboard
(setq select-enable-primary t)

;; No evil snipe mode if there is avy!
(remove-hook 'doom-first-input-hook #'evil-snipe-mode)
(define-key evil-normal-state-map (kbd "s") 'evil-avy-goto-char-timer)
(define-key evil-normal-state-map (kbd "S") 'avy-goto-char)

(setq custom-file nil)

;; Antagonist for evil-goto-definition -> g d; jump back with -> g b
(map! :map evil-motion-state-map
      :prefix "g"
      "b" #'evil-jump-backward)

;; Set chromium as browser
;; Normally the default browser is fine, but with brave/chromium on the same machine things getting tricky
(setq browse-url-browser-function 'browse-url-chromium)
#+end_src

** Theming, Fonts
#+begin_src emacs-lisp
;; There are two ways to load a theme. Both assume the theme is installed and available. You can either set `doom-theme' or manually load a theme with the `load-theme' function. This is the default:
(setq doom-theme 'doom-laserwave)

;; This determines the style of line numbers in effect. If set to `nil', line numbers are disabled. For relative line numbers, set this to `relative'.
(setq display-line-numbers-type t)

;; Fonts settings
(setq doom-font (font-spec :family "JetBrains Mono" :size 15)
      doom-variable-pitch-font (font-spec :family "Noto Sans" :size 15)
      doom-big-font (font-spec :family "JetBrains Mono" :size 24))
(after! doom-themes
  (setq doom-themes-enable-bold t
        doom-themes-enable-italic t))
(custom-set-faces!
  '(font-lock-comment-face :slant italic)
  '(font-lock-keyword-face :slant italic))
#+end_src
* Yas Snippets
#+begin_src emacs-lisp
(setq +snippets-dir "~/sysconf/_home-manager/emacs/snippets")
#+end_src
* Consult
#+begin_src emacs-lisp
(map! :leader
      :desc "Quick Buffer/File Switcher" "SPC" #'consult-buffer)

(map! :leader
      :prefix "s"
      :desc "Consult Org Goto Heading" "g" #'consult-org-heading
      :desc "Consult Org Agenda" "a" #'consult-org-agenda
      :desc "Consult Ripgrep" "p" #'consult-ripgrep)
#+end_src
* Org
** Base Settings
#+begin_src emacs-lisp
;; Org Mode - Base Settings
(setq org-directory "~/Dropbox/org/"
      org-global-properties '(("Effort_ALL" . "0:05 0:10 0:25 0:50 1:15 1:40 2:05 2:55 3:45 4:35 5:25 6:15 7:05"))
      org-agenda-files
      (append
       (list (concat org-directory "_tags.org")
             (concat org-directory "_stage.org")
             (concat org-directory "_habits.org"))
       (directory-files
        org-directory t
        (concat "^W" (format-time-string "%V"))))
      org-agenda-bulk-custom-functions
      '((?m (lambda () (call-interactively 'org-agenda-date-later-minutes)))
        (?h (lambda () (call-interactively 'org-agenda-date-later-hours))))
      org-id-link-to-org-use-id 'create-if-interactive
      org-complete-tags-always-offer-all-agenda-tags t
      org-agenda-start-with-clockreport-mode t
      org-agenda-clockreport-parameter-plist '(:link t :properties ("ALLTAGS" "Effort") :fileskip0 t :compact t)
      org-support-shift-select 'always
      org-goto-interface 'outline-path-completion
      org-startup-with-inline-images t)
#+end_src
** Org agenda
:PROPERTIES:
:ID:       1261439c-2fd1-45b9-b320-d78b8895d824
:END:
#+begin_src emacs-lisp
;; Custom org agenda shortcut
(defun org-agenda-week (&optional arg)
  (interactive "P")
  (org-agenda arg "a"))

(map! :leader :prefix "o" :map global-map :desc "Open Org Agenda Week" "w" #'org-agenda-week)

;; Icons in agenda view
(cl-defstruct caticon
  category
  icon)

;; https://github.com/domtronn/all-the-icons.el
;; https://faicons.com/
(setq caticons (list
  (make-caticon :category "italian" :icon "language")
  (make-caticon :category "spanish" :icon "language")
  (make-caticon :category "create" :icon "code")
  (make-caticon :category "docs" :icon "book")
  (make-caticon :category "debug" :icon "bug")
  (make-caticon :category "slack" :icon "cog")
  (make-caticon :category "debug" :icon "bug")
  (make-caticon :category "fun" :icon "coffee")
  (make-caticon :category "off" :icon "power-off")
))

(customize-set-value
    'org-agenda-category-icon-alist
    (mapcar (lambda (x) (list (caticon-category x) (list (all-the-icons-faicon (caticon-icon x) :height 1)) nil nil)) caticons))
#+end_src
** Org habit
#+begin_src emacs-lisp
(after! org
  (add-to-list 'org-modules 'org-habit))
#+end_src
** Org Refile
#+begin_src emacs-lisp
;; Org Refile Targets
(after! org-refile
  (setq org-refile-targets
        '((nil :maxlevel . 1)
          (org-agenda-files :maxlevel . 1)
          ("~/Dropbox/org/_archive.org" :maxlevel . 1)
          ("~/Dropbox/org/_stage.org" :maxlevel . 1))))
#+end_src
** Org Capture
I capture every activity on my laptop by (broad) category. May change over time. Currently, there are following activities:
- development - concrete project development
- research - various technology related explorative/design work
- operations - linux/emacs related time sinks
- spanish - language learning
- cooking - offline topic; Gathering of cooking recipes
#+begin_src emacs-lisp
;; Org Capture Templates
(after! org-capture
  (setq org-capture-templates
         '(("p" "Blog Post" entry (file+headline "~/data/git/ja.nz/README.org" "Posts") "* TODO %^{title}\nSCHEDULED: %t%^{export_hugo_bundle}p%^{export_file_name}p\n#+begin_description\n%?\n#+end_description\n** scratchpad :noexport:\n" :prepend t :jump-to-captured t)
           ("x" "Instant Todo" entry (function org-journal-open-current-journal-file) "* TODO %^{title}\nSCHEDULED: %T%^{CATEGORY}p%^{Effort}p\n%?" :jump-to-captured t))))
#+end_src
*** Backup (untangled)
Backup of the Doom Emacs Capture templates for future reference
#+begin_src
;;https://github.com/hlissner/doom-emacs/blob/f621ff80471e8d08a72e5ece00641c70b121873a/modules/lang/org/config.el#L342
(("t" "Personal todo" entry
  (file+headline +org-capture-todo-file "Inbox")
  "* [ ] %?\n%i\n%a" :prepend t)
 ("n" "Personal notes" entry
  (file+headline +org-capture-notes-file "Inbox")
  "* %u %?\n%i\n%a" :prepend t)
 ("j" "Journal" entry
  (file+olp+datetree +org-capture-journal-file)
  "* %U %?\n%i\n%a" :prepend t)
 ("p" "Templates for projects")
 ("pt" "Project-local todo" entry
  (file+headline +org-capture-project-todo-file "Inbox")
  "* TODO %?\n%i\n%a" :prepend t)
 ("pn" "Project-local notes" entry
  (file+headline +org-capture-project-notes-file "Inbox")
  "* %U %?\n%i\n%a" :prepend t)
 ("pc" "Project-local changelog" entry
  (file+headline +org-capture-project-changelog-file "Unreleased")
  "* %U %?\n%i\n%a" :prepend t)
 ("o" "Centralized templates for projects")
 ("ot" "Project todo" entry #'+org-capture-central-project-todo-file "* TODO %?\n %i\n %a" :heading "Tasks" :prepend nil)
 ("on" "Project notes" entry #'+org-capture-central-project-notes-file "* %U %?\n %i\n %a" :heading "Notes" :prepend t)
 ("oc" "Project changelog" entry #'+org-capture-central-project-changelog-file "* %U %?\n %i\n %a" :heading "Changelog" :prepend t))
#+end_src
** Org Journal
#+begin_src emacs-lisp
;; Org Journal Settings
(setq org-journal-dir org-directory
      org-journal-date-prefix "#+title: "
      org-journal-date-format "W%V_%Y-%m-%d"
      org-journal-time-prefix "* "
      org-journal-file-format "W%V_%Y-%m-%d.org"
      org-journal-file-header "#+ref: file:_stage.org\n"
      ;; But #+title tag back to first line
      org-journal-after-header-create-hook (lambda () (transpose-lines 1))
      ;; Automatic org agenda integration
      org-journal-after-entry-create-hook
      (lambda () (if (not (file-exists-p (buffer-file-name))) (org-agenda-file-to-front t))))
;;org-journal-file-header "#+title: W%V_%Y-%m-%d\n#+roam_key: file:_stage.org\n"
;;org-journal-skip-carryover-drawers (list "LOGBOOK")


(map! :leader :prefix "r"
        (:map org-mode-map
         :desc "Org Set Property" "p" #'org-set-property
         :desc "Org Set Effort" "e" #'org-set-effort
         :desc "Org Set Tags" "t" #'org-set-tags-command
         :desc "Org Agenda File To Front" "a" #'org-agenda-file-to-front)
        (:map global-map
         :desc "Org Journal New Entry" "n" #'org-journal-new-entry
         :desc "Org Journal New Scheduled Entry" "s" #'org-journal-new-scheduled-entry
         :desc "Org Journal Open Current" "r" #'org-journal-open-current-journal-file))
;; (use-package! org-journal
;;   :bind (:map org-mode-map
;;          ("M-s-n p" . org-set-property) ;; CATEGORY
;;          ("M-s-n e" . org-set-effort) ;; Effort
;;          ("M-s-n t" . org-set-tags-command) ;; Tag
;;          ("M-s-n d" . org-update-all-dblocks) ;; Dblock
;;          ("M-s-n f" . export-clocktable-csv) ;; Export Clock to csv
;;          ("M-s-n a" . org-agenda-file-to-front) ;; add current file to agenda files
;;          :map global-map
;;          ("M-s-n n" . org-journal-new-entry) ;; Entry
;;          ("M-s-n r" . org-journal-open-current-journal-file) ;; Current file
;;          ("M-s-n s" . org-journal-new-scheduled-entry))) ;; Scheduled
#+end_src
*** Export Clocktable Function
#+begin_src emacs-lisp
(defun export-clocktable-csv (&optional week)
  "Export current week (no prefix argument) or weeks in the "
  (interactive "P")
  (let* ((week (if week week 0))
         (time-string (format-time-string "%V"))
         (new-time-number (- (string-to-number time-string) week))
         (new-time-string (number-to-string new-time-number))
         (time-string (if (< new-time-number 10)
                          (concat "0" new-time-string) new-time-string))
         (org-agenda-files (directory-files org-directory t (concat "^W" time-string))))
    (call-interactively #'org-clock-csv-to-file)))
#+end_src
** Org Roam
#+begin_src emacs-lisp
;; Org Roam Settings
(setq +org-roam-open-buffer-on-find-file nil
      org-roam-directory org-directory
      org-roam-capture-templates
      '(("d" "default" plain
         "%?"
         :if-new
         (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                    "#+title: ${title}\n#+CREATED: %(org-insert-time-stamp (org-read-date nil t \"+0d\"))\n#+REVISION: %(org-insert-time-stamp (org-read-date nil t \"+0d\"))\n#+STARTUP: fold\n")
         :unnarrowed t)))

(after! org-roam
  (setq org-roam-completion-everywhere nil))

(defun org_roam__bump_revision_date ()
  "Retriving REVISION and replace it naively with current time stamp."
  (when (string-match-p "^[0-9]\\{14\\}-" (file-name-base))
    (let ((lastrev (car (cdr (car (org-collect-keywords '("REVISION"))))))
          (today (format-time-string (org-time-stamp-format))))
      (cond ((not lastrev) nil)
            ((not (string= lastrev today))
             (progn (push-mark)
                    (re-search-backward "REVISION" nil 1)
                    (if (re-search-forward lastrev nil 1)
                        (replace-match today))
                    (pop-global-mark)))))))

(add-hook! org-mode
  (add-hook 'after-save-hook #'org_roam__bump_revision_date))

;; (use-package! org-roam
;;   :bind (:map org-mode-map
;;          ("M-s-s i" . org-roam-node-insert) ;; insert links in org documents
;;          ("M-s-s b" . org-roam-buffer-toggle) ;; toggle backlinks overview
;;          :map global-map
;;          ("M-s-s f" . org-roam-node-find) ;; quickly find
;;          ("M-s-s c" . org-roam-capture))) ;; capture information

(map! :leader :prefix "r"
        (:map org-mode-map
         :desc "Org Roam Node Insert" "i" #'org-roam-node-insert
         :desc "Org Roam Buffer Toggle" "b" #'org-roam-buffer-toggle)
        (:map global-map
         :desc "Org Roam Goto Node" "g" #'org-roam-node-find
         :desc "Org Roam Capture" "c" #'org-roam-capture))
#+end_src
** Org MRU Clock
#+begin_src emacs-lisp :tangle ~/.doom.d/packages.el
(package! org-mru-clock)
#+end_src

#+begin_src emacs-lisp
(map! :map org-mode-map :localleader :prefix "c"
      :desc "Org MRU clock" "m" #'org-mru-clock-in
      :desc "Org Update All DBlocks" "u" #'org-update-all-dblocks)

;; (use-package! org-mru-clock
;;   :bind (:map global-map
;;          ("M-s-t r" . org-mru-clock-in)
;;          ("M-s-t i" . org-clock-in)
;;          ("M-s-t o" . org-clock-out)
;;          ("M-s-t u" . org-update-all-dblocks)))
#+end_src
** Org pomodoro
#+begin_src emacs-lisp
(after! org-pomodoro
  (setq org-pomodoro-audio-player (executable-find "notify-send")))

(setq org-pomodoro-start-sound-p t
      org-pomodoro-killed-sound-p t
      org-pomodoro-start-sound " *org-pomodoro* - ⏱START⏱"
      org-pomodoro-finished-sound " *org-pomodoro* - 🏃FINISH🏃"
      org-pomodoro-overtime-sound " *org-pomodoro* - ⏰OVERTIME⏰"
      org-pomodoro-killed-sound " *org-pomodoro* - 💀KILLED💀"
      org-pomodoro-short-break-sound " *org-pomodoro* - 🍰SHORT BREAK FINISHED🍰"
      org-pomodoro-long-break-sound " *org-pomodoro* - 🍖LONG BREAK FINISHED🍖"
      org-pomodoro-ticking-sound " *org-pomodoro* - 🥁ticktack🥁")
#+end_src
** Org table copy cell :hack:
#+begin_src emacs-lisp
(defun org-table-yank-cell ()
  "Copy cell value and trim surrounding whitepaces."
  (interactive)
  (when (org-at-table-p)
    (kill-new
      (string-trim
        (substring-no-properties(org-table-get-field))))))
#+end_src

* MU4E
[[ https://github.com/hlissner/doom-emacs/blob/develop/modules/email/mu4e/README.org][Doom Emacs MU4E]]
#+begin_src emacs-lisp
;; Mu4e settings
(add-to-list 'load-path "~/.nix-profile/share/emacs/site-lisp/mu4e")
(after! mu4e
  (setq mu4e-update-interval 300
        mu4e-sent-messages-behavior (lambda () (if (string-suffix-p "gmail.com" (message-sendmail-envelope-from)) 'delete 'sent))))

(setq mu4e-get-mail-command "mbsync -a"
      starttls-use-gnutls t
      message-citation-line-format "On %a, %d %b %Y at %R, %f wrote:\n"
      message-citation-line-function 'message-insert-formatted-citation-line)
#+end_src

** mail@ja.nz
#+begin_src emacs-lisp
(set-email-account! "mail@ja.nz"
                    '((user-mail-address . "mail@ja.nz")
                      (user-full-name . "Ja0nz")
                      (mu4e-sent-folder . "/mail@ja.nz/Sent")
                      (mu4e-drafts-folder . "/mail@ja.nz/Drafts")
                      (mu4e-trash-folder . "/mail@ja.nz/Trash")
                      (mu4e-refile-folder . "/mail@ja.nz/Archive")
                      (mu4e-compose-signature . "\n🤖 Jan Peteler\n💌 mail@ja.nz\n🔖 ja.nz")
                      (smtpmail-smtp-server . "smtp.purelymail.com")
                      (smtpmail-smtp-service . 587)
                      (smtpmail-smtp-user . "mail@ja.nz")
                      (smtpmail-stream-type . starttls)))
#+end_src
** jan.peteler@gmail.com
#+begin_src emacs-lisp
(set-email-account! "jan.peteler@gmail.com"
                    '((user-mail-address . "jan.peteler@gmail.com")
                      (user-full-name . "Jan")
                      (mu4e-sent-folder . "/jan.peteler@gmail.com/Sent")
                      (mu4e-drafts-folder . "/jan.peteler@gmail.com/Drafts")
                      (mu4e-trash-folder . "/jan.peteler@gmail.com/Trash")
                      (mu4e-refile-folder . "/jan.peteler@gmail.com/Archive")
                      (mu4e-compose-signature . "\n🤖 Jan Peteler\n💌 jan.peteler@gmail.com\n🔖 ja.nz")
                      (smtpmail-smtp-server . "smtp.gmail.com")
                      (smtpmail-smtp-service . 587)
                      (smtpmail-smtp-user . "jan.peteler@gmail.com")
                      (smtpmail-stream-type . starttls)))
#+end_src
** Org Contacts Action
#+begin_src emacs-lisp
(setq mu4e-org-contacts-file "~/org/contacts.org")
(after! mu4e
  (add-to-list 'mu4e-headers-actions '("org-contact-add" . mu4e-action-add-org-contact) t)
  (add-to-list 'mu4e-view-actions '("org-contact-add" . mu4e-action-add-org-contact) t))
#+end_src
* Magit *deprecated* -> SPC g g
#+begin_src
(use-package! magit
  :bind (:map global-map
         ("M-s-m m" . magit-status)))
#+end_src
* Calendar
#+begin_src emacs-lisp
(setq calendar-date-style "european"
      calendar-week-start-day 1)
#+end_src
* Terminal Here
#+begin_src emacs-lisp :tangle ~/.doom.d/packages.el
(package! terminal-here)
#+end_src

#+begin_src emacs-lisp
(setq terminal-here-linux-terminal-command '("alacritty"))
(use-package! terminal-here
  :init
  (map! :leader
        :prefix "o"
        :desc "Launch terminal here" "t" #'terminal-here-launch
        :desc "Launch terminal ROOT" "T" #'terminal-here-project-launch))
#+end_src

* Envrc global mode
#+begin_src emacs-lisp
(envrc-global-mode)
#+end_src

* Racket mode
#+begin_src emacs-lisp
;;(add-to-list '+format-on-save-enabled-modes 'racket-mode t)
#+end_src

* JS/TS mode
#+begin_src emacs-lisp
;;https://github.com/js-emacs/xref-js2
(setq xref-js2-search-program 'rg)
#+end_src

* Ascii-art-to-unicode
#+begin_src emacs-lisp :tangle ~/.doom.d/packages.el
(package! ascii-art-to-unicode)
#+end_src
* Web Mode
** Config
#+begin_src emacs-lisp
(setq web-mode-markup-indent-offset 2)
#+end_src

** Web Mode :hack:
Related to this issue of web mode: https://github.com/fxbois/web-mode/issues/799
In short: changing dir-locals alone is not working with web mode. This is a hack
to get it working.

#+begin_src emacs-lisp
(add-to-list 'safe-local-variable-values '(hack-web-mode-engine . "go"))
(defun hack-web-mode-hook ()
  "Hooks for Web mode. Add a local hook which set the engine to the one specified by
   `hack-web-mode-engine` local variable."
  (add-hook
   'hack-local-variables-hook
   (lambda ()
     (if (boundp 'hack-web-mode-engine)
         (progn
           (message "web-mode-engine is %s" hack-web-mode-engine)
           (web-mode-set-engine hack-web-mode-engine))
       (progn
         (message "no web-mode-engine settled")
         (web-mode-set-engine "none"))))))
(add-hook 'web-mode-hook  'hack-web-mode-hook nil nil)
#+end_src
